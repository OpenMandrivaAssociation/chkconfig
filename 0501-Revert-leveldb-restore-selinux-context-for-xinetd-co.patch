From b9a6c29c308c8ec10fe0e0b229487bd0fa2d8906 Mon Sep 17 00:00:00 2001
From: Colin Guthrie <colin@mageia.org>
Date: Tue, 23 Jun 2015 19:13:04 +0100
Subject: [PATCH 501/501] Revert "leveldb: restore selinux context for xinetd
 conf files"

This reverts commit 527b858260911e7139a752a78d78ddead674963a.
---
 chkconfig.spec |  2 +-
 leveldb.c      | 49 +++++--------------------------------------------
 2 files changed, 6 insertions(+), 45 deletions(-)

diff --git a/chkconfig.spec b/chkconfig.spec
index 9f52c9b..fd334c5 100644
--- a/chkconfig.spec
+++ b/chkconfig.spec
@@ -7,7 +7,7 @@ Group: System Environment/Base
 URL: https://git.fedorahosted.org/git/chkconfig.git
 Source: http://fedorahosted.org/releases/c/h/chkconfig/%{name}-%{version}.tar.bz2
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
-BuildRequires: newt-devel gettext popt-devel libselinux-devel
+BuildRequires: newt-devel gettext popt-devel
 Conflicts: initscripts <= 5.30-1
 
 %description
diff --git a/leveldb.c b/leveldb.c
index 1af3a6f..352076c 100644
--- a/leveldb.c
+++ b/leveldb.c
@@ -27,9 +27,6 @@
 #include <stdio.h>
 #include <string.h>
 #include <unistd.h>
-#include <selinux/selinux.h>
-#include <selinux/label.h>
-#include <libgen.h>
 
 /* Changes
    1998-09-22 - Arnaldo Carvalho de Melo <acme@conectiva.com.br>
@@ -41,36 +38,6 @@
 
 #include "leveldb.h"
 
-int selinux_restore(const char *name) {
-        struct selabel_handle *hnd = NULL;
-        struct stat buf;
-        security_context_t newcon = NULL;
-        int r = -1;
-
-        hnd = selabel_open(SELABEL_CTX_FILE, NULL, 0);
-        if (hnd == NULL)
-                goto out;
-
-        r = stat(name, &buf);
-        if (r < 0)
-                goto out;
-
-        r = selabel_lookup_raw(hnd, &newcon, name, buf.st_mode);
-        if (r < 0)
-                goto out;
-
-        r = setfilecon_raw(name, newcon);
-        if (r < 0)
-                goto out;
-
-        r = 0;
-
- out:
-        selabel_close(hnd);
-        freecon(newcon);
-        return r;
-}
-
 int parseLevels(char * str, int emptyOk) {
     char * chptr = str;
     int rc = 0;
@@ -777,7 +744,6 @@ int setXinetdService(struct service s, int on) {
 	char *buf, *ptr, *tmp;
 	struct stat sb;
         mode_t mode;
-        int r;
 
 	if (on == -1) {
 		on = s.enabled ? 1 : 0;
@@ -824,11 +790,7 @@ int setXinetdService(struct service s, int on) {
 	}
 	close(newfd);
 	unlink(oldfname);
-        r = rename(newfname,oldfname);
-        if (selinux_restore(oldfname) != 0)
-                fprintf(stderr, _("Unable to set selinux context for %s: %s\n"), oldfname,
-		strerror(errno));
-	return(r);
+	return(rename(newfname,oldfname));
 }
 
 int doSetService(struct service s, int level, int on) {
@@ -860,12 +822,11 @@ int doSetService(struct service s, int level, int on) {
 
 int systemdIsInit() {
     char *path = realpath("/sbin/init", NULL);
-    char *base = NULL;
+    char *base;
 
     if (!path)
         return 0;
     base = basename(path);
-    puts(base);
     if (!base)
         return 0;
     if (strcmp(base,"systemd"))
@@ -1257,10 +1218,10 @@ void checkSystemdDependencies(struct service *s) {
                         }
                 }
         }
-
-
+        
+       
 finish:
-
+                
         if(star) {
                 for (i = 0; i < n_star; i++)
                         free(star[i]);
-- 
2.3.2

