Subject: [PATCH] From ab9a8c940d22da552df9159987c364282a2b02e5 Mon Sep 17 00:00:00 2001
From: Frederic Crozat <fcrozat@mandriva.com>

Subject: [PATCH] Introduce runlevel 7, acting as runlevel S

Signed-off-by: Frederic Crozat <fcrozat@mandriva.com>

---

 chkconfig.c |   26 +++++++++++++-------------
 leveldb.c   |    4 ++--
 ntsysv.c    |    8 ++++----
 3 files changed, 19 insertions(+), 19 deletions(-)

diff --git a/chkconfig.c b/chkconfig.c
index 2130f61..3fa4228 100644
--- a/chkconfig.c
+++ b/chkconfig.c
@@ -125,7 +125,7 @@ static int delService(char *name, int type, int level) {
 	}
     }
 
-    for (j = 0 ; j < 7; j++) {
+    for (j = 0 ; j < 8; j++) {
 	 if (level == -1 || level == j) {
 		 if (!findServiceEntries(name, j, &globres)) {
 			 for (i = 0; i < globres.gl_pathc; i++)
@@ -158,7 +158,7 @@ static inline int earlierThan(int i, int j) {
 static int isSimilarlyConfigured(struct service s, struct service t, int start) {
         int i, state_s, state_t;
 
-        for (i = 0; i <= 6; i ++) {
+        for (i = 0; i <= 7; i ++) {
                 if (isConfigured(s.name, i, NULL, NULL)) {
                         state_s = isOn(s.name, i);
                 } else {
@@ -234,7 +234,7 @@ static int frobOneDependencies(struct service *s, struct service *servs, int num
 
 	int resolved = (s0 != s->sPriority) || (k0 != s->kPriority);
 	if (target || resolved) {
-		for (i = 0; i < 7; i++) {
+		for (i = 0; i < 8; i++) {
 			if (isConfigured(s->name, i, NULL, NULL)) {
 				int on = isOn(s->name, i);
 				delService(s->name, TYPE_INIT_D, i);
@@ -296,7 +296,7 @@ static int addService(char * name, int type) {
     if (s.isLSB)
 		rc = frobDependencies(&s);
     else
-    for (i = 0; i < 7; i++) {
+    for (i = 0; i < 8; i++) {
 	if (!isConfigured(name, i, NULL, NULL)) {
 	    if ((1 << i) & s.levels)
 		doSetService(s, i, 1);
@@ -345,7 +345,7 @@ static int overrideService(char * name, int srvtype) {
      * at all.
      */
 
-    for (level = 0; level < 7; level++) {
+    for (level = 0; level < 8; level++) {
 	thisLevelAdded = isConfigured(name, level, &priority, &type);
         thisLevelOn = s.levels & 1<<level;
         if (thisLevelAdded) {
@@ -365,7 +365,7 @@ static int overrideService(char * name, int srvtype) {
     }
 
     if (configured && doChange) {
-        for (level = 0; level < 7; level++) {
+        for (level = 0; level < 8; level++) {
             if (!findServiceEntries(name, level, &globres)) {
                 for (i = 0; i < globres.gl_pathc; i++)
                     unlink(globres.gl_pathv[i]);
@@ -388,7 +388,7 @@ static int showServiceInfo(struct service s, int forgiving) {
 
     if (s.type == TYPE_INIT_D) {
 	    rc = 2;
-	    for (i = 0 ; i < 7 ; i++) {
+	    for (i = 0 ; i < 8 ; i++) {
 		    if (isConfigured(s.name, i, NULL, NULL)) {
 			    rc = 0;
 			    break;
@@ -408,7 +408,7 @@ static int showServiceInfo(struct service s, int forgiving) {
 	    return 0;
     }
 
-    for (i = 0; i < 7; i++) {
+    for (i = 0; i < 8; i++) {
 	printf("\t%d:%s", i, isOn(s.name, i) ? _("on") : _("off"));
     }
     printf("\n");
@@ -439,7 +439,7 @@ static int isXinetdEnabled() {
 	if (readServiceInfo("xinetd", TYPE_INIT_D, &s, 0)) {
 		return 0;
 	}
-	for (i = 0; i < 7; i++) {
+	for (i = 0; i < 8; i++) {
 		if (isOn("xinetd", i))
 		  return 1;
 	}
@@ -529,11 +529,11 @@ int setService(char * name, int type, int where, int state) {
     struct service s;
 
     if (!where && state != -1) {
-	/* levels 2, 3, 4, 5 */
-	where = (1 << 2) | (1 << 3) | (1 << 4) | (1 << 5);
+	/* levels 2, 3, 4, 5, 7 */
+	where = (1 << 2) | (1 << 3) | (1 << 4) | (1 << 5) | (1 << 7);
     } else if (!where) {
 	where = (1 << 0) | (1 << 1) | (1 << 2) |
-	        (1 << 3) | (1 << 4) | (1 << 5) | (1 << 6);
+	        (1 << 3) | (1 << 4) | (1 << 5) | (1 << 6) | (1 << 7);
     }
 
     if ((rc = readServiceInfo(name, type, &s, 0))) {
@@ -548,7 +548,7 @@ int setService(char * name, int type, int where, int state) {
 
 	    if (s.isLSB)
 		    frobDependencies(&s);
-	    for (i = 0; i < 7; i++) {
+	    for (i = 0; i < 8; i++) {
 
 		    if (!((1 << i) & where)) continue;
 
diff --git a/leveldb.c b/leveldb.c
index 5b7f428..18f6b02 100644
--- a/leveldb.c
+++ b/leveldb.c
@@ -46,7 +46,7 @@ int parseLevels(char * str, int emptyOk) {
 	return emptyOk ? 0 : -1;
 
     while (*chptr) {
-	if (!isdigit(*chptr) || *chptr > '6') return -1;
+	if (!isdigit(*chptr) || *chptr > '7') return -1;
 	rc |= 1 << (*chptr - '0');
 	chptr++;
     }
@@ -226,7 +226,7 @@ int readXinetdServiceInfo(char *name, struct service * service) {
 			  } while(isspace(*buf));
 
 			if (buf && strncmp(buf,"yes",3)) {
-				serv.levels = parseLevels("0123456",0);
+				serv.levels = parseLevels("01234567",0);
 				if (serv.enabled == -1)
 				  serv.enabled = 1;
 			} else {
diff --git a/ntsysv.c b/ntsysv.c
index 14c5940..681f50b 100644
--- a/ntsysv.c
+++ b/ntsysv.c
@@ -66,13 +66,13 @@ static int servicesWindow(struct service * services, int numServices,
 				     services[i].levels ? '*' : ' ', NULL,
 				     states + i);
 	} else {
-		for (j = 0; j < 7; j++) {
+		for (j = 0; j < 8; j++) {
 			if (levels & (1 << j)) {
 				if (isOn(services[i].name, j)) break;
 			}
 		}
 		checkboxes[i] = newtCheckbox(-1, i, services[i].name,
-					     (j != 7) ? '*' : ' ', NULL,
+					     (j != 8) ? '*' : ' ', NULL,
 					     states + i);
 	}
 	newtFormAddComponent(subform, checkboxes[i]);
@@ -136,7 +136,7 @@ static int servicesWindow(struct service * services, int numServices,
 	    (!services[i].enabled && states[i] == '*'))
 	      setXinetdService(services[i], states[i] == '*');
       } else {
-	      for (j = 0; j < 7; j++) {
+	      for (j = 0; j < 8; j++) {
 		      if (levels & (1 << j))
 			doSetService(services[i], j, states[i] == '*');
 	      }
@@ -198,7 +198,7 @@ static int getServices(struct service ** servicesPtr, int * numServicesPtr,
 		int i;
 
 		rc = -2;
-		for (i = 0 ; i < 7 ; i++) {
+		for (i = 0 ; i < 8 ; i++) {
 			if (isConfigured(ent->d_name, i, NULL, NULL)) {
 				rc = 0;
 				break;
